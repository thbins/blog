테라폼이 실행되는 디렉터리를 모듈이라고 합니다. 모듈에는 테라폼 코드 정의를 위한 tf 또는 tf.json 확장자의 파일과 tfvars 같은 변수를 정의하는 파일이 포함됩니다. 일반적으로 기본 작업 디렉터리의 정의된 파일 집합을 '루트 모듈'이라고 하며, 루트 모듈은 다른 모듈을 호출해 해당 루트 모듈이 구성하는 리소스 구성을 포함시킬 수 있고, 이렇게 호출되는 모듈을 '자식 모듈'이라고 합니다.



#### terraform init 명령

`terrafrom init` 명령은 테라폼 구성 파일이 있는 작업 디렉터리를 초기화하는 데 사용합니다.

테라폼을 시작하는 데 사용하는 첫 번째 명령어로 테라폼에서 사용되는 프로바이더, 모듈 등의 지정된 버전에 맞춰 루트 모듈을 구성하는 역할을 수행합니다.

또한 자동화 구성을 위한 파이프라인 설계 시 테라폼을 실행하는 시점에 필수적으로 요구되는 명령어입니다.

![terraform init 명령 실행 예시](img/20251110_terraform(1).png)

</br>

#### terraform init -upgrade 옵션에 대해서

![](img/20251110_terraformupgrade.png)

0.14 버전 이후부터 프로바이더 종속성을 고정시키는 .terraform.lock.hcl 파일이 추가됩니다. 작업자가 로컬에서 init으로 받은 프로바이더, 모듈 버전으로 수행한 이후 다른 작업자나 리모트 환경에서 init을 수행하는 경우, 지속적으로 업그레이드되는 각 프로바이더와 모듈로 인해 변경된 버전으로 설치될 가능성이 있습니다. 따라서 작업 당시의 버전 정보를 기입하고, .terraform.lock.hcl 파일이 있으면 해당 파일에 명시된 버전으로 init을 수행합니다. 이후 작업자가 의도적으로 버전을 변경하거나 코드에 명시한 다른 버전으로 변경하려면 `terraform init -upgrade` 명령을 수행해야 합니다.

**.terraform.lock.hcl = 팀 전체가 같은 버전을 쓰도록 보장하는 잠금 파일**이라고 생각하시면 좋을 것 같습니다.

</br>

#### terraform validate 명령

Validate 라는 커맨드 단어의 의미대로 디렉터리에 있는 테라폼 구성 파일의 유효성을 확인합니다.
이때 대상이 되는 인프라와 서비스의 상태를 확인하기 위해 원격 작업이나 API 작업은 발생하지 않고, 코드적인 유효성만 검토합니다.

![20251110_terraformvalidate](img/20251110_terraformvalidate.png)

 local_file 리소스 정의에는 filename 인수가 필수이지만 해당 인수가 정의되지 않았기 때문에, `terraform validate` 명령을 수행할 경우 해당 정의를 찾을 수 없다는 에러 메시지를 확인할 수 있습니다.

</br>

#### terraform validate -json 명령

서브커맨드 옵션 중에 `-json` 옵션을 사용할 수 있는 명령어는 실행 결과를 JSON 형식으로 출력할 수 있습니다. 프로비저닝 파이프라인을 설계하는 경우 결과에 대한 쿼리가 필요할 수 있습니다. 이때 JSON 형태의 출력 데이터를 이용하면 프로비저닝 과정의 조건 및 데이터로 사용 가능합니다.

![20251110_terraformvalidatejson](img/20251110_terraformvalidatejson.png)

</br>

#### terraform plan 명령

`terraform plan` 명령은 테라폼으로 적용할 인프라의 변경 사항에 관한 실행 계획을 생성하는 동작입니다.
또한 출력되는 결과를 통해 어떤 변경이 적용될지 사용자가 미리 검토하고 이해하는 데 도움을 줍니다.
`plan` 명령은 변경 사항을 실제로 적용하지 않으므로, 적용 전에 예상한 구성이 맞는지 검토하는 데 주료 이용됩니다.

- 테라폼 실행 이전의 상태와 비교해 현재 상태가 최신화되었는지 확인합니다.
- 적용하고자 하는 구성을 현재 상태와 비교하고 변경점을 확인합니다.
- 구성이 적용되는 경우 대상이 테라폼 구성을 어떻게 반영되는지 확인합니다.

![20251110_terraformplan](img/20251110_terraformplan.png)

- terraform plan 명령을 실행하면 처음 출력된 로그에서 심볼이 가진 의미를 설명합니다.
- 아래에는 테라폼 구성 내용을 바탕으로 어떤 리소스가 생성되는지 상세 내역을 출력합니다. 실행 계힉을 살펴보면 코드 구성에서는 local_file 리소스를 정의할 때 필수 요소인 content와 file_name만 선언했지만, 리소스에 정의 가능한 다른 옵션의 내용과 기본값이 자동으로 입력되어 적용되는 것을 확인할 수 있습니다. 이를 통해 해당 구성이 특정 리소스에 대해 생성될 때 어떤 값이 기본값으로 설정되는지 확인할 수 있습니다.
- 마지막으로 이 실행 계획을 적용할 경우 하나의 리소스가 추가되고, 변경되거나 삭제되는 것은 없다는 것을 설명합니다.

</br>

#### terraform plan -detailed-exitcode 명령

`-detailed-exitcode` 옵션은 실행 계획을 생성하는 명령과 함께 사용하기 좋은 옵션으로, 파이프라인 설계에서 활용할 수 있습니다. 옵션이 없던 때와 결과는 같지만 exitcode가 환경 변수로 구성됩니다.

```
# 리눅스 및 macOS에서 terraform plan 결과를 시스템 코드로 출력하는 방법
terraform plan -detailed-exitcode
echo $?
> 2

# Windows에서 terraform plan의 결과를 시스템 코드로 출력하는 방법
terraform plan -detailed-exitcode

CMD> echo %errorlevel%
> 2

PowerShell> echo $LASTEXITCODE
> 2
```

exitcode 또는 errorlevel은 동작의 결과를 숫자 코드로 제공합니다. 각 숫자 코드는 자동화된 동작을 설계할 때 그 뒤 작업을 수행할지, 사용자에게 알릴지, 정지할지 등을 나타냅니다. 각 숫자의 의미는 아래와 같습니다.

-   0 : 변경 사항이 없는 성공
-   1 : 오류가 있음
-   2 : 변경 사항이 있는 성공
